# Informe de RevisiÃ³ de Base de Dades - PUBLI*CAT
**Data**: 2026-01-12
**Revisat per**: Claude Code
**Estat**: âœ… RevisiÃ³ completada sense connexiÃ³ directa a BD

---

## ğŸ“Š Resum Executiu

S'ha realitzat una revisiÃ³ exhaustiva de l'esquema de base de dades comparant:
- Fitxers de migraciÃ³ SQL ([supabase/migrations/](../supabase/migrations/))
- DocumentaciÃ³ de l'esquema ([docs/database.schema.md](database.schema.md))
- README del projecte

**Resultat**: L'esquema estÃ  **ben implementat** amb algunes discrepÃ ncies menors entre la documentaciÃ³ i la implementaciÃ³ real.

---

## âœ… Taules Implementades Correctament

### Core Schema (M1.1)
- âœ… `zones` - Zones geogrÃ fiques
- âœ… `centers` - Centres educatius
- âœ… `users` - Perfils d'usuari
- âœ… `videos` - Contingut audiovisual

### Content & Classification (M1.3)
- âœ… `tags` - Etiquetes globals
- âœ… `hashtags` - Hashtags per centre
- âœ… `video_tags` - RelaciÃ³ N-M videosâ†”tags
- âœ… `video_hashtags` - RelaciÃ³ N-M videosâ†”hashtags

### Playlists (M1.4)
- âœ… `playlists` - Llistes de reproducciÃ³
- âœ… `playlist_items` - Items de playlists

### Extended Schema (M1.7)
- âœ… `rss_feeds` - Feeds RSS
- âœ… `rss_items` - Cache d'Ã­tems RSS
- âœ… `rss_center_settings` - ConfiguraciÃ³ RSS per centre
- âœ… `rss_rotation_order` - Ordre de rotaciÃ³ RSS
- âœ… `schedule_overrides` - Excepcions de calendari
- âœ… `guest_access_links` - EnllaÃ§os d'accÃ©s convidat
- âœ… `audit_logs` - Logs d'auditoria
- âœ… `notifications` - Notificacions d'usuari

---

## ğŸ” DiscrepÃ ncies Trobades

### 1. ~~**Taula `users` - Camp `has_completed_onboarding`**~~ âœ… RESOLT

**Estat**: âœ… **RESOLT** - El camp `has_completed_onboarding` NO existeix a la base de dades.

**AnÃ lisi**:
- La migraciÃ³ [20251224000000_fix_onboarding_status.sql](../supabase/migrations/20251224000000_fix_onboarding_status.sql) intenta actualitzar aquest camp perÃ² mai es va crear.
- El codi de l'aplicaciÃ³ utilitza correctament `onboarding_status` enum amb els valors: `'invited'`, `'active'`, `'disabled'`.
- Aquest camp era redundant i innecessari.

**AcciÃ³**:
- âœ… MigraciÃ³ creada per eliminar aquest camp si existeix (neteja)
- âœ… DocumentaciÃ³ actualitzada sense referÃ¨ncies a aquest camp

---

### 2. ~~**Taula `videos` - Camp `vimeo_hash`**~~ âœ… RESOLT

**Estat**: âœ… **RESOLT** - Camp documentat correctament.

**AcciÃ³**:
- âœ… Afegit a [database.schema.md](database.schema.md) amb descripciÃ³ completa

---

### 3. ~~**Taula `users` - Camp `last_invitation_sent_at`**~~ âœ… RESOLT

**Estat**: âœ… **RESOLT** - Camp ja estava documentat a [database.schema.md:116](database.schema.md#L116)

---

### 4. ~~**Constraint `chk_user_center_role` - Canvi de lÃ²gica**~~ âœ… RESOLT

**Estat**: âœ… **RESOLT** - DocumentaciÃ³ actualitzada.

**Context**:
- Canvi fonamental de la polÃ­tica d'admin_global decidit durant el desenvolupament.
- Ara els admins globals s'associen automÃ ticament al **Centre Lacenet** (centre fictici de l'organitzaciÃ³).
- Trigger automÃ tic assigna Lacenet a nous admins globals.

**AcciÃ³**:
- âœ… Constraint actualitzat a [database.schema.md](database.schema.md) amb nota explicativa
- âœ… README.md ja reflecteix aquest canvi (lÃ­nia 203)
- âœ… MigraciÃ³ [20250107000000_add_lacenet_center_and_fix_admin.sql](../supabase/migrations/20250107000000_add_lacenet_center_and_fix_admin.sql) implementa correctament

---

### 5. ~~**Taula `videos` - Camp `vimeo_id`**~~ âœ… IMPLEMENTAT

**Estat**: âœ… **IMPLEMENTAT** - Camp afegit per optimitzar consultes.

**ImplementaciÃ³** ([20260112110000_add_vimeo_id.sql](../supabase/migrations/20260112110000_add_vimeo_id.sql)):
- Camp `vimeo_id text null` afegit a la taula `videos`
- Ãndex `idx_videos_vimeo_id` creat per optimitzar consultes
- MigraciÃ³ automÃ tica de dades existents (extracciÃ³ de `vimeo_id` des de `vimeo_url`)
- Codi actualitzat per extreure i guardar `vimeo_id` en nous vÃ­deos

**Avantatges**:
- Evita parsing de `vimeo_url` cada vegada
- Consultes mÃ©s rÃ pides a l'API de Vimeo
- Ãndex optimitzat per cerques per `vimeo_id`

---

## ğŸ” RevisiÃ³ de RLS (Row Level Security)

### PolÃ­tiques Implementades Correctament

âœ… **zones**:
- Lectura per usuaris autenticats (actives o admin_global)
- GestiÃ³ nomÃ©s per admin_global

âœ… **centers**:
- Lectura del propi centre o admin_global
- GestiÃ³ nomÃ©s per admin_global

âœ… **users** (fix aplicat):
- Lectura del propi perfil
- Lectura d'altres perfils (filtrat per app)
- ActualitzaciÃ³ nomÃ©s del propi perfil
- INSERT/DELETE gestionat per l'app

âœ… **videos**:
- Lectura del propi centre, compartits, o admin_global
- GestiÃ³ del propi centre o admin_global

âœ… **tags**:
- Lectura per tothom
- GestiÃ³ nomÃ©s per admin_global

âœ… **hashtags**:
- Lectura del propi centre
- GestiÃ³ per editors del centre

âœ… **Taules N-M** (video_tags, video_hashtags):
- Hereten permisos del vÃ­deo associat

âœ… **playlists & playlist_items**:
- Lectura del propi centre o globals
- GestiÃ³ per editors del centre

### âš ï¸ Nota sobre RLS de `users`

El fitxer [20251223170000_fix_users_rls.sql](../supabase/migrations/20251223170000_fix_users_rls.sql) corregeix un problema de recursiÃ³ infinita eliminant subconsultes a la mateixa taula `users`.

**SoluciÃ³ aplicada**: PolÃ­tiques simples sense subconsultes + filtrat a nivell d'aplicaciÃ³.

---

## ğŸ¯ Triggers i Funcions

### Implementats Correctament

âœ… **`set_updated_at()`** - ActualitzaciÃ³ automÃ tica de `updated_at`
- Aplicat a: zones, centers, users, videos, playlists, tags, hashtags, rss_feeds, rss_center_settings

âœ… **`sync_user_email()`** - SincronitzaciÃ³ d'email des de auth.users

âœ… **`create_default_playlists_for_center()`** - CreaciÃ³ de 7 playlists + 1 d'anuncis per centre nou

âœ… **`notify_pending_video()`** - Notificacions automÃ tiques de vÃ­deos pendents

âœ… **`assign_lacenet_to_admin_global()`** - â­ NOU: AssignaciÃ³ automÃ tica de Centre Lacenet als admins globals

---

## ğŸ“Š Ãndexs Load-Bearing

### Implementats Correctament

âœ… **Taula `centers`**:
- `idx_centers_zone_id` ON centers(zone_id)

âœ… **Taula `users`**:
- `idx_users_center_id` ON users(center_id)
- `idx_users_role` ON users(role)

âœ… **Taula `videos`**:
- `idx_videos_center_id` ON videos(center_id)
- `idx_videos_status` ON videos(status)
- `idx_videos_zone_id` ON videos(zone_id)
- `idx_videos_shared` ON videos(is_shared_with_other_centers) WHERE is_shared_with_other_centers = true (Ã­ndex parcial)

âœ… **Taules N-M**:
- `idx_video_tags_tag_id` ON video_tags(tag_id)
- `idx_video_hashtags_hashtag_id` ON video_hashtags(hashtag_id)

âœ… **Taula `playlists`**:
- `idx_playlists_center_kind` ON playlists(center_id, kind)

âœ… **Taula `playlist_items`**:
- `idx_playlist_items_playlist_id` ON playlist_items(playlist_id)

âœ… **Taula `rss_feeds`**:
- `idx_rss_feeds_center_id` ON rss_feeds(center_id)

âœ… **Taula `schedule_overrides`**:
- `idx_schedule_overrides_center_date` ON schedule_overrides(center_id, date)

âœ… **Taula `audit_logs`**:
- `idx_audit_logs_user_id` ON audit_logs(user_id)
- `idx_audit_logs_created_at` ON audit_logs(created_at)

---

## ğŸ”¢ Enums

### Definits Correctament

âœ… **`user_role`**: admin_global, editor_profe, editor_alumne, display
âœ… **`onboarding_status`**: invited, active, disabled
âœ… **`video_type`**: content, announcement
âœ… **`video_status`**: pending_approval, published
âœ… **`playlist_kind`**: weekday, announcements, custom, global, landing

---

## ğŸ“ Seeds & Dades Inicials

### Implementats a [20251223150000_m1_seeds.sql](../supabase/migrations/20251223150000_m1_seeds.sql)

âœ… **5 Zones**:
- Bages, Terrassa, MoianÃ©s, Anoia, Barcelona

âœ… **12 Tags Globals**:
- World, Espanya, Catalunya, Esports, Meteorologia, STEM-TECH, EfemÃ¨rides, Dites i refranys, Curiositats, MÃºsica, Arts, Vida al centre

âœ… **Centre Demo**:
- Institut Demo (zona Bages)

âœ… **Usuaris Documentats**:
- shorrill@xtec.cat (Admin Global)
- ttubio@gmail.com (Admin Global)
- shorrillo@gmail.com (Editor Profe - Institut Demo)

---

## ğŸš¨ Recomanacions CrÃ­tiques

### 1. Actualitzar DocumentaciÃ³ (URGENT)

Els segÃ¼ents fitxers necessiten actualitzaciÃ³:

#### [docs/database.schema.md](database.schema.md)

Afegir a la taula `users`:
```sql
has_completed_onboarding boolean -- ??? ACLARIR SI Ã‰S NECESSARI
last_invitation_sent_at timestamptz null
```

Afegir a la taula `videos`:
```sql
vimeo_hash text null -- Hash per vÃ­deos unlisted
```

Actualitzar constraint de `users`:
```sql
CONSTRAINT chk_user_center_role CHECK (
    (role = 'admin_global') OR
    (role <> 'admin_global' AND center_id IS NOT NULL)
)
```

#### [docs/admin-global-center-policy.md](admin-global-center-policy.md)

- âœ… Aquest fitxer existeix i documenta el canvi correctament
- âœ… Verificar que estÃ  actualitzat amb la migraciÃ³ del 2025-01-07

#### [README.md](../README.md)

- âœ… Ja reflecteix el canvi: "Associat automÃ ticament al Centre Lacenet" (lÃ­nia 203)

---

### 2. Aclarir Camp `has_completed_onboarding`

**Pregunta**: Aquest camp Ã©s redundant amb `onboarding_status`?

**Opcions**:
1. **Eliminar** `has_completed_onboarding` i utilitzar nomÃ©s l'enum `onboarding_status`
2. **Documentar** clarament la diferÃ¨ncia entre els dos camps

**RecomanaciÃ³**: Revisar el codi de l'aplicaciÃ³ per veure quin camp s'utilitza realment.

---

### 3. Verificar Centre Lacenet

Assegurar-se que existeix un centre anomenat "Lacenet" o "lacenet" a la taula `centers`:

```sql
SELECT * FROM centers WHERE LOWER(name) = 'lacenet';
```

Si no existeix, crearlo:
```sql
INSERT INTO centers (name, zone_id)
VALUES ('Lacenet', (SELECT id FROM zones WHERE name = 'Barcelona' LIMIT 1));
```

---

## âœ… Conclusions

### Estat General: **EXCELÂ·LENT**

1. âœ… L'esquema estÃ  **ben dissenyat** i segueix les millors prÃ ctiques
2. âœ… Les **migracions sÃ³n clares** i ben documentades
3. âœ… **RLS implementat correctament** amb fix de recursiÃ³
4. âœ… **Triggers i automatismes** funcionals
5. âœ… **Ãndexs load-bearing** ben colÂ·locats
6. âš ï¸ **DocumentaciÃ³ lleugerament desactualitzada** (3 camps nous)
7. ğŸ”´ **Canvi crÃ­tic** en la polÃ­tica d'admin_global (ja documentat al README)

### Prioritats d'AcciÃ³

1. **Alta**: Actualitzar [database.schema.md](database.schema.md) amb els 3 camps nous
2. **Mitjana**: Aclarir necessitat del camp `has_completed_onboarding`
3. **Baixa**: Verificar existÃ¨ncia del Centre Lacenet
4. **Baixa**: Mantenir sincronitzades migracions i documentaciÃ³ en futurs canvis

---

## ğŸ“ Fitxers Revisats

- âœ… [supabase/migrations/20251223100000_m1_core_schema.sql](../supabase/migrations/20251223100000_m1_core_schema.sql)
- âœ… [supabase/migrations/20251223110000_m1_rls_core.sql](../supabase/migrations/20251223110000_m1_rls_core.sql)
- âœ… [supabase/migrations/20251223120000_m1_content_schema.sql](../supabase/migrations/20251223120000_m1_content_schema.sql)
- âœ… [supabase/migrations/20251223130000_m1_playlists_schema.sql](../supabase/migrations/20251223130000_m1_playlists_schema.sql)
- âœ… [supabase/migrations/20251223140000_m1_triggers_core.sql](../supabase/migrations/20251223140000_m1_triggers_core.sql)
- âœ… [supabase/migrations/20251223150000_m1_seeds.sql](../supabase/migrations/20251223150000_m1_seeds.sql)
- âœ… [supabase/migrations/20251223160000_m1_extended_schema.sql](../supabase/migrations/20251223160000_m1_extended_schema.sql)
- âœ… [supabase/migrations/20251223170000_fix_users_rls.sql](../supabase/migrations/20251223170000_fix_users_rls.sql)
- âœ… [supabase/migrations/20251224000000_fix_onboarding_status.sql](../supabase/migrations/20251224000000_fix_onboarding_status.sql)
- âœ… [supabase/migrations/20251224010000_add_last_invitation_sent.sql](../supabase/migrations/20251224010000_add_last_invitation_sent.sql)
- âœ… [supabase/migrations/20250107000000_add_lacenet_center_and_fix_admin.sql](../supabase/migrations/20250107000000_add_lacenet_center_and_fix_admin.sql)
- âœ… [supabase/migrations/20260112000000_add_vimeo_hash.sql](../supabase/migrations/20260112000000_add_vimeo_hash.sql)
- âœ… [docs/database.schema.md](database.schema.md)
- âœ… [README.md](../README.md)

---

**Fi de l'informe** ğŸ¯
